<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لعبة الجاسوس</title>
  <button5 onclick="goBack()">
    <i class="fas fa-arrow-left"></i> Go Back
  </button5>
  <script>
    function goBack() {
      window.history.back();
    }
  </script>
<style>
        button5 {
background-color: #007BFF;
color: white;
border: none;
padding: 10px 20px;
font-size: 16px;
border-radius: 5px;
cursor: pointer;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
display: flex;
align-items: center;
gap: 10px; /* Space between icon and text */
transition: background-color 0.3s ease, transform 0.2s ease;
}

button5 i {
font-size: 18px; /* Icon size */
}



button5:active {
background-color: #003f7f;
transform: scale(1);
}
    body {
        font-family: 'Poppins', sans-serif;
        text-align: center;
        background: linear-gradient(135deg, #e3f2fd, #ffffff);
        margin: 0;
        padding: 0;
        color: #333333;
    }

    #game-container {
        margin: 60px auto;
        max-width: 500px;
        background: #ffffff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    button {
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        color: #ffffff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 162, 255, 0.4);
    }

    button:disabled {
        background: #d3dce6;
        cursor: not-allowed;
    }

    #timer {
        font-size: 24px;
        font-weight: bold;
        color: #ff6b6b;
        margin-top: 20px;
    }

    input {
        display: block;
        margin: 15px auto;
        padding: 14px;
        font-size: 16px;
        font-weight: 500;
        width: calc(100% - 50px);
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: #f9f9f9;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus {
        outline: none;
        border-color: #4facfe;
        box-shadow: 0 0 6px rgba(79, 172, 254, 0.5);
    }
</style>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div id="game-container">
    <h1>لعبة الجاسوس</h1>
    <div id="auth-area">
      <h2>تسجيل الدخول</h2>
      <button id="google-login-btn">تسجيل الدخول باستخدام Google</button>
    </div>
    <div id="game-setup" style="display: none;">
      <h2>اللاعبون</h2>
      <p id="players-count">عدد اللاعبين: 0</p>
      <button id="leaveGameBtn">خروج من اللعبة</button>
      <button id="join-game">انضم إلى اللعبة</button>
      <button id="start-game" disabled>ابدأ اللعبة</button>
    </div>
    <div id="game-area" style="display: none;">
      <p>لعبة الجاسوس بدأت!</p>
      <p id="timer">الوقت المتبقي: 5:00</p>
      <button id="reveal-role">كشف الدور</button>
    </div>
    <div id="voting-area" style="display: none;">
      <h2>اختر من هو الجاسوس:</h2>
      <ul id="voting-list"></ul>
      <p id="most-voted-realtime">لم يتم التصويت بعد.</p>
      <button id="submit-vote">إرسال التصويت</button>
    </div>
    <div id="results-area" style="display: none;">
      <h2>نتائج اللعبة</h2>
      <p id="most-voted"></p>
      <p id="real-spy"></p>
      <p id="your-choice"></p>
      <button id="reset-game">إعادة تعيين اللعبة</button>
    </div>
  </div>
  <script>

 const firebaseConfig = {
  apiKey: "AIzaSyB0Aj452H6Gp1ociH4ufHrLiU6Uucb-ysM",
  authDomain: "who-is-the-spy-51308.firebaseapp.com",
  databaseURL: "https://who-is-the-spy-51308-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "who-is-the-spy-51308",
  storageBucket: "who-is-the-spy-51308.firebasestorage.app",
  messagingSenderId: "900253646275",
  appId: "1:900253646275:web:b9f7a3cbb1069a07d2d176",
  measurementId: "G-NWXDDDRPRH"
 };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const authArea = document.getElementById("auth-area");
    const googleLoginBtn = document.getElementById("google-login-btn");
    const gameSetup = document.getElementById("game-setup");
    const gameArea = document.getElementById("game-area");
    const votingArea = document.getElementById("voting-area");
    const resultsArea = document.getElementById("results-area");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const registerBtn = document.getElementById("register-btn");
    const joinGameBtn = document.getElementById("join-game");
    const startGameBtn = document.getElementById("start-game");
    const leaveGameBtn = document.getElementById("leaveGameBtn");
    const revealRoleBtn = document.getElementById("reveal-role");
    const submitVoteBtn = document.getElementById("submit-vote");
    const resetGameBtn = document.getElementById("reset-game");
    const timerElement = document.getElementById("timer");

    const randomWords = ["تفاحة", "قطار", "مدرسة", "بحر", "طائرة"];

    googleLoginBtn.addEventListener("click", async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (error) {
        alert("خطأ أثناء تسجيل الدخول: " + error.message);
      }
    });

    auth.onAuthStateChanged((user) => {
      if (user) {
        authArea.style.display = "none";
        gameSetup.style.display = "block";
      } else {
        authArea.style.display = "block";
        gameSetup.style.display = "none";
      }
    });



    revealRoleBtn.addEventListener("click", () => {
  const user = auth.currentUser;
  if (user) {
    const playerRef = db.ref(`players/${user.uid}`);
    playerRef.once("value", (snapshot) => {
      const playerData = snapshot.val();
      if (playerData) {
        const role = playerData.role || "غير معروف";
        const word = playerData.word || "لا توجد كلمة";
        alert(`دورك: ${role}\nالكلمة: ${word}`);
      } else {
        alert("لم يتم العثور على بيانات اللاعب. يرجى إعادة المحاولة.");
      }
    });
  } else {
    alert("يرجى تسجيل الدخول أولاً.");
  }
});



    auth.onAuthStateChanged((user) => {
      if (user) {
        authArea.style.display = "none";
        gameSetup.style.display = "block";
        fetchPlayers();
        listenToGameState();
      } else {
        authArea.style.display = "block";
        gameSetup.style.display = "none";
      }
    });

    function fetchPlayers() {
  const playersRef = db.ref("players");
  playersRef.on("value", (snapshot) => {
    const players = snapshot.val();
    const playerCount = players ? Object.keys(players).length : 0;
    document.getElementById("players-count").textContent = `عدد اللاعبين: ${playerCount}`;
    startGameBtn.disabled = playerCount < 3;
  });
}


    function listenToGameState() {
      const gameRef = db.ref("game");
      gameRef.on("value", (snapshot) => {
        const gameState = snapshot.val();
        if (gameState && gameState.started) {
          gameSetup.style.display = "none";
          gameArea.style.display = "block";
          startTimer(gameState.startTime, gameState.duration);
        } else {
          gameSetup.style.display = "block";
          gameArea.style.display = "none";
        }
      });
    }

    joinGameBtn.addEventListener("click", () => {
  const user = auth.currentUser;
  if (user) {
    const playerRef = db.ref(`players/${user.uid}`);
    playerRef.set({ name: user.email });
  }
});


    startGameBtn.addEventListener("click", () => {
      const playersRef = db.ref("players");
      playersRef.once("value", (snapshot) => {
        const players = snapshot.val();
        if (players) {
          const playerIds = Object.keys(players);
          const spyIndex = Math.floor(Math.random() * playerIds.length);

          const chosenWord = randomWords[Math.floor(Math.random() * randomWords.length)];

          playerIds.forEach((playerId, index) => {
            let role = "لاعب عادي";
            let word = chosenWord;
           
             if (index === spyIndex) {
              role = "جاسوس";
              word = "";
            }

             db.ref(`players/${playerId}`).update({ role, word });
           });


          const startTime = Date.now();
          const duration = 300; // 5 دقائق
          db.ref("game").set({
            started: true,
            startTime: startTime,
            duration: duration,
          });
        }
      });
    });

    leaveGameBtn.addEventListener("click", () => {
  const user = auth.currentUser;
  if (user) {
    db.ref(`players/${user.uid}`).remove();
  }
});


function startTimer(startTime, duration) {
  const endTime = startTime + duration * 1000;

  const interval = setInterval(() => {
    const currentTime = Date.now();
    const timeLeft = Math.max(0, Math.floor((endTime - currentTime) / 1000));

    if (timeLeft <= 0) {
      clearInterval(interval);
      startVoting();
    }

    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `الوقت المتبقي: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
  }, 1000);
}



    function startVoting() {
      gameArea.style.display = "none";
      votingArea.style.display = "block";

      const votingList = document.getElementById("voting-list");
      votingList.innerHTML = "";

      const playersRef = db.ref("players");
      playersRef.once("value", (snapshot) => {
        const players = snapshot.val();
        if (players) {
          Object.entries(players).forEach(([playerId, player]) => {
            const listItem = document.createElement("li");
            const radioInput = document.createElement("input");
            radioInput.type = "radio";
            radioInput.name = "vote";
            radioInput.value = playerId;

            const label = document.createElement("label");
            label.textContent = player.name;

            listItem.appendChild(radioInput);
            listItem.appendChild(label);
            votingList.appendChild(listItem);
          });
        }
      });

      // تتبع التصويت المباشر
      trackVotesRealtime();
    }

    function trackVotesRealtime() {
      const votesRef = db.ref("votes");
      const playersRef = db.ref("players");
    }

      votesRef.on("value", (votesSnapshot) => {
  const votes = votesSnapshot.val();
  const voteCounts = {};

  if (votes) {
    Object.values(votes).forEach((vote) => {
      voteCounts[vote] = (voteCounts[vote] || 0) + 1;
    });
  }

  let mostVotedPlayerId = null;
  let maxVotes = 0;

  Object.entries(voteCounts).forEach(([playerId, count]) => {
    if (count > maxVotes) {
      maxVotes = count;
      mostVotedPlayerId = playerId;
    }
  });

  playersRef.once("value", (playersSnapshot) => {
    const players = playersSnapshot.val();
    const mostVotedPlayer = players ? players[mostVotedPlayerId] : null;

    const mostVotedElement = document.getElementById("most-voted-realtime");
    mostVotedElement.textContent = mostVotedPlayer
      ? `اللاعب الأكثر تصويتًا حاليًا: ${mostVotedPlayer.name} (${maxVotes} صوت)`
      : "لم يتم التصويت بعد.";
  });
});


    submitVoteBtn.addEventListener("click", () => {
      const selectedPlayer = document.querySelector('input[name="vote"]:checked');
      if (!selectedPlayer) {
        alert("يرجى اختيار لاعب قبل الإرسال.");
        return;
      }

      const user = auth.currentUser;
      if (user) {
        const voteRef = db.ref(votes/'${user.uid}');
        voteRef.set(selectedPlayer.value);
        alert("تم تسجيل تصويتك!");
        votingArea.style.display = "none";
        calculateResults();
      }
    });

    function calculateResults() {
  const votesRef = db.ref("votes");
  const playersRef = db.ref("players");

  votesRef.once("value", (votesSnapshot) => {
    const votes = votesSnapshot.val();
    const voteCounts = {};

    Object.values(votes).forEach((vote) => {
      voteCounts[vote] = (voteCounts[vote] || 0) + 1;
    });

    let mostVotedPlayerId = null;
    let maxVotes = 0;

    Object.entries(voteCounts).forEach(([playerId, count]) => {
      if (count > maxVotes) {
        maxVotes = count;
        mostVotedPlayerId = playerId;
      }
    });

    playersRef.once("value", (playersSnapshot) => {
      const players = playersSnapshot.val();

      const mostVotedPlayer = players[mostVotedPlayerId];
      const realSpy = Object.values(players).find((player) => player.role === "جاسوس");
      const userVote = votes[auth.currentUser.uid];

      document.getElementById("most-voted").textContent = `اللاعب الأكثر تصويتًا: ${mostVotedPlayer ? mostVotedPlayer.name : "غير معروف"}`;
      document.getElementById("real-spy").textContent = `الجاسوس الحقيقي: ${realSpy ? realSpy.name : "غير معروف"}`;
      document.getElementById("your-choice").textContent = `اختيارك: ${players[userVote] ? players[userVote].name : "غير معروف"}`;

      resultsArea.style.display = "block";
    });
  }); // Close votesRef.once
} // Close calculateResults function




    resetGameBtn.addEventListener("click", () => {
      db.ref("game").remove();
      db.ref("players").remove();
      db.ref("votes").remove();

      resultsArea.style.display = "none";
      gameSetup.style.display = "block";
    });
  </script>
</body>
</html>
